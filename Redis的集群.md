**Redis的集群**

首先我们的reids并发量非常的高,但是想淘宝这种大型网站,一台单机redis是完全不够的,这个时候就要用到我的redis的分布式的集群搭建

首先redis服务器我们应该分成两种(读写分离),一种只读,一种只写,这样性能会有很大的提高

但是我们并不知道我们的redis服务器的性能怎么样,怎样的集群才能完成我们redis的正常运行.这个时候就要用到我们官方自带的测试工具redis-benchmark

这款测试工具需要实时的测试已确定redis的实际性能

观察系统在高并发时的TPS(吞吐量),QPS,RT(响应时间)

- RT系统会算出本系统的平均时间,或者最大响应时间
- TPS在指定系统服务器的吞吐量是否在服务器的并发的上限
- QPS每秒的查询率,处理流量多少个来衡量(reids就用QPS来衡量它的性能)

一般redis的写用的服务器较少,而读的QPS需要较大的查询率,已知一台redis服务器的QPS是4.2万,,而较大的网站4.2万是远远不够的,知乎每秒的处理平均约为1500万次.

这个时候需要搭建多台服务器,redis的集群的一台主服务器,和多台从服务器,在新的服务器上,可让本身与主服务器进行连接,主服务器发送数据副本,从服务器通过网络根据主服务器额数据进行准时的更新(更新速度取决于网络宽带),这样大量的用户的请求就可以分发的不用的服务器上面处理

redis自身集成了读写分离,只需在reids的配置文件里面加上一条,slaveof  host port 语句即可

可以把主库当做写服务器,把从库当做读服务器,在从库上面配置主库的IP 和端口号即可

redis主服务器会生成RDB文件,去把主服务器的内容同步到从服务器

在redis2.8版本之前旧版的复制功能sync,是一个非常耗费资源的操作,读和写,文件载入阻塞传输耗费流量都非常占资源.

2.8之后**PSYNC**有完整重同步和部分重同步两种模式.

**完整重同步:**

- 在初次会发送和2.8之前一样的RDB文件,但是以后新增哪个就同步哪个(发送缓存区里的增量命令进行同步).这样比较省资源,相当于以前同步的改善版

**部分重同步:**

- 在主服务器与从服务器断线之后会使用到部分重同步,主服务一旦连不上重服务器,会将断线后的命令放入缓存区中,当从服务器能够连接主服务器时,他将会断线期间的写命令发送给从服务器 

从服务器的复制偏移量会根据主服务器的复制偏移量进行数据的更新同步(就是比较从服务的内容是不是比主的少)

主服务器的复制积压缓存区,默认大小为1M

**在主服务器宕机之后,又有新的服务器来代替主服务器,那这个时候从服务器会执行什么操作?**

- 每个主服务器都有一个唯一运行id,一旦从服务器连接上的主服务器发现id和上次连接的主服务器id不同,会做完整的重同步

